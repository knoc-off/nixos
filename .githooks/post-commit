#!/usr/bin/env bash
# Generate NixOS labels from commit messages

set -euo pipefail

readonly SYSTEMS_DIR="systems"
readonly COMMIT_DIR="$SYSTEMS_DIR/commit-messages"
readonly MAX_LEN=92  # 200 - 15 (REV_) - padding = ~92 per message

mkdir -p "$COMMIT_DIR"

# Clean and truncate message: trim, replace spaces, remove bad chars, truncate
clean_msg() {
    echo "$1" | sed 's/^[[:space:]]*//; s/[[:space:]]*$//; s/ /_/g' | \
    tr -cd 'a-zA-Z0-9:_.-' | cut -c1-${MAX_LEN}
}

global_msg=$(clean_msg "$(git log -1 --pretty=%s)")

for nix_file in "$SYSTEMS_DIR"/*.nix; do
    [[ -f "$nix_file" ]] || continue
    
    file_msg=$(clean_msg "$(git log -1 --pretty=%s -- "$nix_file")")
    base_name="${nix_file##*/}"
    output_file="$COMMIT_DIR/${base_name%.*}-commit-message.nix"
    
    cat > "$output_file" << EOF
{ self, ... }:
{
  system.nixos.label = "${global_msg}" + "REV_" + toString (self.shortRev or self.dirtyShortRev or self.lastModified or "unknown") + "${file_msg}";
}
EOF
    
    git diff --quiet "$output_file" || git add "$output_file"
done

git diff --cached --quiet || git commit --amend --no-edit

